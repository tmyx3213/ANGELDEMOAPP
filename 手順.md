# 開発サーバー起動手順（Windows）

この手順は、Windows 上でフロント（React）とバックエンド（FastAPI）を開発サーバーとして起動するためのものです。

- 前提: Python 3.10 以上、Node.js 18 以上、PowerShell（推奨）
- ルートフォルダ例: `C:\\demoapp`

## 1. バックエンドの起動

- 仮想環境の作成と有効化

```powershell
cd backend
python -m venv .venv
.\\.venv\\Scripts\\Activate.ps1
```

- 依存インストール

```powershell
pip install -r requirements.txt
```

- （任意・Prophetを本稼働させる場合）NumPy を 1.26 系に固定

```powershell
pip uninstall -y numpy
pip install numpy==1.26.4
```

- （任意・Prophetを本稼働させる場合）cmdstan の導入（初回のみ、時間がかかります）

```powershell
python -c "import cmdstanpy as c; c.install_cmdstan(); print('CMDSTAN=', c.cmdstan_path())"
```

- API サーバー起動（デフォルト: 127.0.0.1:8765）

```powershell
uvicorn app:app --reload --port 8765
```

- 動作確認
  - ブラウザで `http://127.0.0.1:8765/docs` が開けばOK

## 2. フロントエンドの起動

別の PowerShell で以下を実行:

```powershell
cd frontend
npm install
npm run dev
```

- ブラウザで `http://localhost:5173` を開く

## 3. 基本的な確認フロー

- 画面上部「サンプルを読み込む」→ プレビューが表示される
- 「次へ」を進め、日付列=Date、値の列=Close を確認
- 「実行」→ 結果タブでグラフと要約が表示
  - Prophet未導入でも、簡易予測に自動フォールバックして動作します

## 4. よくあるエラーと対処

- Vite のプロキシエラー（`ECONNREFUSED 127.0.0.1:8765`）
  - バックエンドが起動しているか確認（上記 1 の手順）
  - ポートを変更した場合は `frontend/vite.config.ts` の `target` を合わせてください

- `/api/forecast` が 500（Internal Server Error）
  - Prophet/Stan 環境未整備または依存不整合の可能性
  - すぐデモしたい場合: そのまま簡易予測で継続可能（画面にフォールバック注意が表示されます）
  - Prophetを使う場合: 「NumPy固定」「cmdstan導入」の2点を実施してから再起動

- フォールバック理由が「too few rows」
  - データ行数が少ないため。対処:
    - 予測期間を 7〜14 日に下げて実行
    - もしくはサンプルCSVを生成して行数を増やす（下記）

## 5. サンプルCSVの生成（任意・ネット接続必要）

バックエンドの仮想環境を有効化した状態で:

```powershell
cd backend
.\\.venv\\Scripts\\Activate.ps1
python scripts/fetch_toyota_csv.py
```

- 全カラム版（Open/High/Low/Close/Volume など含む）を作りたい場合:

```powershell
python scripts/fetch_toyota_csv.py --ticker 7203.T --period 2y --interval 1d --all-columns --output assets/sample/toyota_full_7203.csv
```

- 取得に失敗した場合は、自動で合成データにフォールバックして `backend/assets/sample/toyota_7203.csv` を上書きします
- 画面の「サンプルを読み込む」は、`assets/sample/toyota_full_7203.csv` が存在する場合はそちら（全カラム）を返し、無ければ `toyota_7203.csv`（軽量）を返します

### 5.1 オフラインでフルカラムCSVを作る（簡易生成）

`Date, Close` のみのCSVから、Open/High/Low/Close/Volumeを擬似生成します。

```powershell
cd backend
.\.venv\Scripts\Activate.ps1
python scripts\make_full_from_close.py --input assets\sample\toyota_7203.csv --output assets\sample\toyota_full_7203.csv
```

生成後、「サンプルを読み込む」で全カラムCSVがプレビューされます。

## 6. 終了方法 / 小技

- 終了: 各ターミナルで `Ctrl + C`
- 仮想環境の終了: `deactivate`
- ポートを変更したい場合
  - バックエンド: `uvicorn app:app --reload --port 8787`
  - フロント: `frontend/vite.config.ts` の `target` を `http://127.0.0.1:8787` に変更

## 7. トラブルシューティング（抜粋）

- PowerShell の実行ポリシーで仮想環境が有効化できない
  - 管理者権限の PowerShell を開く、または CMD で `backend\\.venv\\Scripts\\activate` を使用
- 画面は開くがグラフが出ない
  - バックエンドのコンソールにエラーが出ていないか確認（詳細ログ出力済み）
  - CSVの列指定（Date/Close）が合っているか確認

以上です。困ったらバックエンドのコンソールログを貼ってください（詳細なスタックトレースが出るようにしてあります）。
